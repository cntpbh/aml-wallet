<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <title>AML Wallet Screening ‚Äî Compliance Report</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%230891b2'/><text x='8' y='24' font-size='22' fill='white'>A</text></svg>" type="image/svg+xml" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0a0e17; --surface: #111827; --surface-2: #1a2236; --border: #1e2a3e;
      --text: #e2e8f0; --text-muted: #7a8ba7; --accent: #22d3ee; --accent-dim: rgba(34,211,238,0.12);
      --green: #34d399; --yellow: #fbbf24; --red: #f87171; --critical: #ef4444; --radius: 10px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .header { padding:20px 28px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:14px; }
    .logo { width:34px; height:34px; background:linear-gradient(135deg,var(--accent),#6366f1); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:16px; color:#000; }
    .header h1 { font-size:17px; font-weight:600; letter-spacing:-0.02em; }
    .badge { background:var(--accent-dim); color:var(--accent); padding:3px 10px; border-radius:16px; font-size:10px; font-weight:700; letter-spacing:0.06em; text-transform:uppercase; }
    .container { max-width:1100px; margin:0 auto; padding:28px; }
    .input-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:24px; margin-bottom:20px; }
    .input-card h2 { font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:16px; }
    .form-row { display:flex; gap:12px; flex-wrap:wrap; align-items:end; }
    label { display:block; font-size:11px; font-weight:500; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:5px; }
    select, input[type="text"] { width:100%; padding:11px 12px; background:var(--surface-2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:'JetBrains Mono',monospace; font-size:13px; outline:none; transition:border-color 0.2s; }
    select:focus, input:focus { border-color:var(--accent); }
    .btn { padding:11px 22px; border:none; border-radius:8px; font-family:'DM Sans',sans-serif; font-size:13px; font-weight:700; cursor:pointer; transition:transform 0.15s,opacity 0.2s; white-space:nowrap; }
    .btn:hover { transform:translateY(-1px); opacity:0.9; }
    .btn:disabled { opacity:0.4; cursor:wait; }
    .btn-primary { background:linear-gradient(135deg,var(--accent),#6366f1); color:#000; }
    .btn-secondary { background:var(--surface-2); border:1px solid var(--border); color:var(--text); font-weight:600; font-size:12px; }
    .btn-pdf { background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff; }
    .status-bar { padding:14px 20px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:20px; font-size:13px; color:var(--text-muted); display:none; align-items:center; gap:10px; }
    .status-bar.show { display:flex; }
    .spinner { width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .report { display:none; }
    .report.show { display:block; }
    .risk-badge { display:inline-flex; align-items:center; gap:10px; padding:12px 24px; border-radius:8px; font-size:20px; font-weight:700; }
    .risk-LOW { background:rgba(52,211,153,0.1); color:var(--green); border:1px solid rgba(52,211,153,0.25); }
    .risk-MEDIUM { background:rgba(251,191,36,0.1); color:var(--yellow); border:1px solid rgba(251,191,36,0.25); }
    .risk-HIGH { background:rgba(248,113,113,0.1); color:var(--red); border:1px solid rgba(248,113,113,0.25); }
    .risk-CRITICAL { background:rgba(239,68,68,0.12); color:var(--critical); border:2px solid rgba(239,68,68,0.4); }
    .rec { font-size:12px; font-weight:700; padding:6px 14px; border-radius:6px; text-transform:uppercase; letter-spacing:0.06em; }
    .rec-APPROVE { background:rgba(52,211,153,0.12); color:var(--green); }
    .rec-REVIEW { background:rgba(251,191,36,0.12); color:var(--yellow); }
    .rec-BLOCK { background:rgba(248,113,113,0.12); color:var(--red); }
    .meta-row { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:16px; font-size:12px; color:var(--text-muted); }
    .mono { font-family:'JetBrains Mono',monospace; color:var(--accent); font-size:11px; }
    .section { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; margin-bottom:14px; }
    .section h3 { font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:14px; display:flex; align-items:center; gap:8px; }
    .dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
    .finding { padding:12px 16px; border-radius:8px; margin-bottom:8px; font-size:13px; line-height:1.5; display:flex; gap:12px; align-items:flex-start; }
    .finding.sev-CRITICAL { background:rgba(239,68,68,0.08); border-left:3px solid var(--critical); }
    .finding.sev-HIGH { background:rgba(248,113,113,0.08); border-left:3px solid var(--red); }
    .finding.sev-MEDIUM { background:rgba(251,191,36,0.06); border-left:3px solid var(--yellow); }
    .finding.sev-LOW { background:rgba(52,211,153,0.06); border-left:3px solid var(--green); }
    .sev-tag { font-size:10px; font-weight:700; padding:2px 8px; border-radius:4px; white-space:nowrap; text-transform:uppercase; }
    .sev-tag.t-CRITICAL { background:var(--critical); color:#fff; }
    .sev-tag.t-HIGH { background:var(--red); color:#fff; }
    .sev-tag.t-MEDIUM { background:var(--yellow); color:#000; }
    .sev-tag.t-LOW { background:var(--green); color:#000; }
    .data-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px; }
    .data-cell { background:var(--surface-2); padding:12px; border-radius:8px; }
    .data-cell .lbl { font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:4px; }
    .data-cell .val { font-family:'JetBrains Mono',monospace; font-size:14px; font-weight:600; word-break:break-all; }
    .sources-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:10px; }
    .source-pill { display:flex; align-items:center; gap:8px; padding:10px 14px; background:var(--surface-2); border-radius:8px; font-size:12px; }
    .indicator { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
    .indicator.active { background:var(--green); }
    .indicator.inactive { background:var(--text-muted); opacity:0.4; }
    .indicator.error { background:var(--red); }
    .defi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:12px; }
    .defi-card { background:var(--surface-2); padding:14px; border-radius:8px; text-align:center; }
    .defi-card .num { font-size:28px; font-weight:700; font-family:'JetBrains Mono',monospace; }
    .defi-card .lbl { font-size:10px; color:var(--text-muted); text-transform:uppercase; margin-top:4px; }
    .pattern-alert { padding:12px 16px; background:rgba(248,113,113,0.08); border:1px solid rgba(248,113,113,0.3); border-radius:8px; color:var(--red); font-size:13px; font-weight:600; margin-bottom:12px; }
    .kyc-action { padding:10px 14px; background:var(--surface-2); border-radius:8px; margin-bottom:6px; font-size:13px; line-height:1.5; border-left:3px solid var(--accent); }
    .doc-list { margin-top:10px; }
    .doc-item { display:flex; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--border); font-size:12px; }
    .doc-item:last-child { border-bottom:none; }
    .required-tag { color:var(--red); font-weight:700; font-size:10px; text-transform:uppercase; }
    .optional-tag { color:var(--text-muted); font-size:10px; }
    .reg-table { width:100%; border-collapse:collapse; font-size:12px; }
    .reg-table th { background:var(--surface-2); padding:10px; text-align:left; font-weight:600; color:var(--text-muted); text-transform:uppercase; font-size:10px; letter-spacing:0.06em; }
    .reg-table td { padding:10px; border-bottom:1px solid var(--border); }
    .priority-tag { font-size:10px; font-weight:700; padding:2px 8px; border-radius:4px; }
    .pri-IMEDIATA,.pri-CRITICA,.pri-CR√çTICA { background:rgba(248,113,113,0.15); color:var(--red); }
    .pri-ALTA { background:rgba(251,191,36,0.15); color:var(--yellow); }
    .pri-PADR√ÉO { background:rgba(52,211,153,0.1); color:var(--green); }
    .transparency-bar { height:12px; background:var(--surface-2); border-radius:6px; overflow:hidden; margin:8px 0; }
    .transparency-fill { height:100%; border-radius:6px; transition:width 0.5s; }
    .audit-entry { display:flex; gap:12px; padding:8px 0; border-bottom:1px solid var(--border); font-size:11px; }
    .audit-entry:last-child { border-bottom:none; }
    .audit-action { font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--accent); min-width:140px; }
    .actions { display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
    .json-viewer { background:var(--surface-2); padding:16px; border-radius:8px; font-family:'JetBrains Mono',monospace; font-size:11px; line-height:1.6; max-height:400px; overflow:auto; white-space:pre-wrap; display:none; margin-top:12px; }
    .json-viewer.show { display:block; }
    .disclaimer { margin-top:20px; padding:14px; background:rgba(251,191,36,0.06); border:1px solid rgba(251,191,36,0.15); border-radius:8px; font-size:11px; color:var(--yellow); line-height:1.5; }

    /* Payment Modal */
    .modal-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,.85); z-index:1000; display:none; align-items:center; justify-content:center; }
    .modal-overlay.show { display:flex; }
    .modal { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:32px; max-width:520px; width:90%; max-height:85vh; overflow-y:auto; }
    .modal h2 { font-size:18px; font-weight:700; margin-bottom:16px; display:flex; align-items:center; gap:10px; }
    .modal-close { background:none; border:none; color:var(--text-muted); font-size:22px; cursor:pointer; margin-left:auto; }
    .wallet-box { background:var(--surface-2); border:1px solid var(--accent); border-radius:8px; padding:14px; margin:16px 0; font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--accent); word-break:break-all; cursor:pointer; text-align:center; transition:background .2s; }
    .wallet-box:hover { background:rgba(34,211,238,.08); }
    .pay-amount { font-size:28px; font-weight:800; text-align:center; margin:16px 0; color:var(--accent); font-family:'JetBrains Mono',monospace; }
    .pay-step { display:flex; gap:12px; align-items:flex-start; margin:12px 0; }
    .pay-step-num { width:24px; height:24px; border-radius:50%; background:var(--accent-dim); color:var(--accent); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:11px; flex-shrink:0; }
    .pay-step-text { font-size:12px; color:var(--text-muted); }
    .pay-step-text strong { color:var(--text); }
    .pay-status { text-align:center; padding:16px; border-radius:8px; margin:16px 0; font-size:13px; font-weight:600; }
    .pay-status.checking { background:rgba(251,191,36,.1); color:var(--yellow); }
    .pay-status.success { background:rgba(52,211,153,.1); color:var(--green); }
    .pay-status.error { background:rgba(248,113,113,.1); color:var(--red); }
    .btn-blockchain { background:linear-gradient(135deg,#C8963E,#E8C872); color:#0F1B33; }
    .blockchain-info { margin-top:12px; padding:14px; background:var(--surface-2); border:1px solid rgba(52,211,153,.2); border-radius:8px; font-size:11px; }
    .blockchain-info a { color:var(--accent); text-decoration:none; }
    .blockchain-info a:hover { text-decoration:underline; }
    .tx-row { display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid var(--border); font-size:12px; }
    .tx-row:last-child { border-bottom:none; }
    .tx-dir { font-size:10px; font-weight:700; padding:2px 8px; border-radius:4px; min-width:32px; text-align:center; }
    .tx-dir.dir-IN { background:rgba(52,211,153,0.12); color:var(--green); }
    .tx-dir.dir-OUT { background:rgba(248,113,113,0.12); color:var(--red); }
    .tx-addr { font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--accent); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .tx-val { font-family:'JetBrains Mono',monospace; font-size:11px; font-weight:600; white-space:nowrap; }
    .tx-date { font-size:10px; color:var(--text-muted); white-space:nowrap; }
    .cp-row { display:flex; align-items:center; gap:10px; padding:8px 12px; border-bottom:1px solid var(--border); font-size:12px; }
    .cp-row:last-child { border-bottom:none; }
    .cp-count { background:var(--surface-2); padding:2px 8px; border-radius:4px; font-size:11px; font-weight:700; font-family:'JetBrains Mono',monospace; color:var(--accent); }
    .token-badge { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:var(--surface-2); border-radius:8px; font-size:12px; margin:4px; }
    .token-badge .sym { font-weight:700; color:var(--accent); }
    .token-badge .bal { font-family:'JetBrains Mono',monospace; }
    .flash-alert { padding:14px 18px; border-radius:10px; margin-bottom:12px; font-size:13px; line-height:1.6; }
    .flash-alert.flash-danger { background:rgba(220,38,38,0.12); border:2px solid var(--red); color:var(--red); }
    .flash-alert.flash-safe { background:rgba(5,150,105,0.08); border:1px solid rgba(5,150,105,0.3); color:var(--green); }
    .flash-alert.flash-warn { background:rgba(217,119,6,0.08); border:1px solid rgba(217,119,6,0.3); color:var(--yellow); }
    .flash-token-item { display:flex; align-items:center; gap:10px; padding:10px 14px; border-bottom:1px solid var(--border); font-size:12px; }
    .flash-token-item:last-child { border-bottom:none; }
    .flash-status { font-size:10px; font-weight:700; padding:3px 10px; border-radius:5px; white-space:nowrap; }
    .flash-status.status-ok { background:rgba(5,150,105,0.12); color:var(--green); }
    .flash-status.status-fake { background:rgba(220,38,38,0.15); color:var(--red); }
    .flash-status.status-warn { background:rgba(217,119,6,0.12); color:var(--yellow); }
    .no-findings { padding:20px; text-align:center; color:var(--green); font-size:14px; }

    /* Auth */
    .auth-bar { display:flex; align-items:center; gap:8px; }
    .auth-bar .user-email { font-size:11px; color:var(--accent); font-weight:600; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .auth-input { width:100%; padding:10px 12px; background:var(--surface-2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:13px; font-family:inherit; outline:none; margin-bottom:10px; }
    .auth-input:focus { border-color:var(--accent); }
    .auth-tabs { display:flex; margin-bottom:16px; border-radius:8px; overflow:hidden; border:1px solid var(--border); }
    .auth-tab { flex:1; padding:10px; text-align:center; font-size:12px; font-weight:600; cursor:pointer; background:var(--surface-2); color:var(--text-muted); border:none; font-family:inherit; transition:all .2s; }
    .auth-tab.active { background:var(--accent-dim); color:var(--accent); }
    .auth-msg { text-align:center; padding:10px; border-radius:8px; font-size:12px; margin-top:10px; }
    .auth-msg.error { background:rgba(248,113,113,.1); color:var(--red); }
    .auth-msg.success { background:rgba(52,211,153,.1); color:var(--green); }

    /* Report History */
    .history-panel { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; margin-bottom:20px; }
    .history-panel h3 { font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:.08em; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
    .history-list { max-height:200px; overflow-y:auto; }
    .hist-item { display:flex; align-items:center; gap:10px; padding:8px 10px; border-bottom:1px solid var(--border); cursor:pointer; transition:background .15s; border-radius:4px; }
    .hist-item:hover { background:var(--surface-2); }
    .hist-item:last-child { border:none; }
    .hist-risk { font-size:9px; font-weight:800; padding:2px 8px; border-radius:4px; min-width:48px; text-align:center; }
    .hist-risk.LOW { background:rgba(52,211,153,.12); color:var(--green); }
    .hist-risk.MEDIUM { background:rgba(251,191,36,.12); color:var(--yellow); }
    .hist-risk.HIGH { background:rgba(248,113,113,.12); color:var(--red); }
    .hist-risk.CRITICAL { background:rgba(239,68,68,.15); color:var(--critical); }
    .hist-addr { font-family:'JetBrains Mono',monospace; font-size:11px; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .hist-chain { font-size:10px; color:var(--text-muted); text-transform:uppercase; }
    .hist-date { font-size:10px; color:var(--text-muted); }
    .hist-bc { font-size:8px; color:var(--green); }
    .hist-empty { text-align:center; padding:16px; font-size:12px; color:var(--text-muted); }

    /* Package selector */
    .pkg-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
    .pkg-card { border:1.5px solid var(--border); border-radius:10px; padding:16px; cursor:pointer; transition:all .2s; text-align:center; }
    .pkg-card:hover { border-color:var(--accent); }
    .pkg-card.selected { border-color:var(--accent); background:var(--accent-dim); }
    .pkg-price { font-family:'JetBrains Mono',monospace; font-size:22px; font-weight:800; color:var(--accent); }
    .pkg-label { font-size:11px; color:var(--text-muted); margin-top:4px; }
    .pkg-credits { font-size:12px; font-weight:700; color:var(--text); margin-top:4px; }

    @media (max-width:700px) {
      .form-row,.defi-grid { flex-direction:column; grid-template-columns:1fr 1fr; }
      .data-grid,.sources-grid { grid-template-columns:1fr 1fr; }
      .pkg-grid { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="/" style="text-decoration:none;display:flex;align-items:center;gap:10px">
      <img src="logo_dark.png" alt="Proposito" style="height:30px" onerror="this.onerror=null;this.src='data:image/png;base64,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'">
    </a>
    <h1>Prop√≥sito AML</h1>
    <span class="badge">v2.6</span>
    <div style="margin-left:auto;display:flex;align-items:center;gap:12px">
      <div id="creditDisplay" style="font-size:11px;color:var(--text-muted);display:flex;align-items:center;gap:6px">
        <span style="background:var(--accent-dim);color:var(--accent);padding:3px 8px;border-radius:6px;font-weight:700;font-family:'JetBrains Mono',monospace" id="creditCount">1</span>
        <span>consultas</span>
      </div>
      <button class="btn btn-secondary" onclick="openPaymentModal()" style="padding:7px 14px;font-size:11px">Comprar Cr√©ditos</button>
      <div class="auth-bar" id="authBar">
        <button class="btn btn-secondary" onclick="openAuthModal()" id="authBtn" style="padding:7px 14px;font-size:11px">Entrar</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- INPUT -->
    <div class="input-card">
      <h2>Consultar Carteira</h2>
      <div class="form-row">
        <div style="flex:0 0 180px">
          <label for="chain">Rede</label>
          <select id="chain">
            <option value="ethereum">Ethereum (ETH/ERC-20)</option>
            <option value="tron">TRON (TRC-20 / USDT)</option>
            <option value="bsc">BSC (BNB/BEP-20)</option>
            <option value="polygon">Polygon (MATIC)</option>
            <option value="arbitrum">Arbitrum (ARB)</option>
            <option value="bitcoin">Bitcoin (BTC)</option>
          </select>
        </div>
        <div style="flex:1;min-width:200px">
          <label for="address">Endere√ßo da carteira</label>
          <input type="text" id="address" placeholder="0x... / T... / bc1... / 1..." spellcheck="false" autocomplete="off" />
        </div>
        <button class="btn btn-primary" id="btnScreen" onclick="runScreening()">Analisar Risco</button>
      </div>
    </div>

    <div class="status-bar" id="statusBar"><div class="spinner"></div><span id="statusText"></span></div>

    <!-- REPORT HISTORY -->
    <div class="history-panel" id="historyPanel" style="display:none">
      <h3>Relat√≥rios Anteriores <span id="histCount" style="font-family:'JetBrains Mono',monospace;color:var(--accent)"></span></h3>
      <div class="history-list" id="historyList"></div>
    </div>

    <!-- REPORT -->
    <div class="report" id="reportSection">
      <div id="reportHeader" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;margin-bottom:16px"></div>
      <div class="meta-row" id="metaRow"></div>

      <!-- Findings -->
      <div class="section" id="findingsSection"><h3><span class="dot" style="background:var(--red)"></span> Indicadores de Risco</h3><div id="findingsList"></div></div>

      <!-- DeFi Analysis -->
      <div class="section" id="defiSection" style="display:none"><h3><span class="dot" style="background:var(--critical)"></span> An√°lise DeFi ‚Äî Mixer / Bridge / DEX / Saltos Opacos</h3><div id="defiContent"></div></div>

      <!-- Flash Token Detection -->
      <div class="section" id="flashSection" style="display:none"><h3><span class="dot" style="background:var(--yellow)"></span> Verifica√ß√£o Flash USDT / Tokens Falsos</h3><div id="flashContent"></div></div>

      <!-- KYC -->
      <div class="section" id="kycSection" style="display:none"><h3><span class="dot" style="background:var(--accent)"></span> KYC ‚Äî Due Diligence Obrigat√≥ria</h3><div id="kycContent"></div></div>

      <!-- AML/KYT -->
      <div class="section" id="amlSection" style="display:none"><h3><span class="dot" style="background:var(--green)"></span> AML/KYT ‚Äî Monitoramento Ativo</h3><div id="amlContent"></div></div>

      <!-- Regulatory -->
      <div class="section" id="regSection" style="display:none"><h3><span class="dot" style="background:var(--yellow)"></span> Coopera√ß√£o Regulat√≥ria</h3><div id="regContent"></div></div>

      <!-- On-chain Data -->
      <div class="section" id="onchainSection"><h3><span class="dot" style="background:var(--green)"></span> Monitoramento On-Chain</h3><div class="data-grid" id="onchainGrid"></div><div id="tokenBalances" style="margin-top:12px"></div></div>

      <!-- Recent Transactions -->
      <div class="section" id="txSection" style="display:none"><h3><span class="dot" style="background:var(--accent)"></span> Transa√ß√µes Recentes</h3><div id="txList"></div></div>

      <!-- Top Counterparties -->
      <div class="section" id="cpSection" style="display:none"><h3><span class="dot" style="background:var(--text-muted)"></span> Principais Counterparties</h3><div id="cpList"></div></div>

      <!-- Transparency -->
      <div class="section" id="transSection" style="display:none"><h3><span class="dot" style="background:var(--text-muted)"></span> Prova de Reservas / Transpar√™ncia</h3><div id="transContent"></div></div>

      <!-- Audit Trail -->
      <div class="section" id="auditSection" style="display:none"><h3><span class="dot" style="background:var(--accent)"></span> Trilha de Auditoria</h3><div id="auditContent"></div></div>

      <!-- Sources -->
      <div class="section"><h3><span class="dot" style="background:var(--text-muted)"></span> Fontes Consultadas</h3><div class="sources-grid" id="sourcesGrid"></div></div>

      <!-- Actions -->
      <div class="actions">
        <button class="btn btn-pdf" onclick="downloadPDF()">Baixar Relat√≥rio PDF</button>
        <button class="btn btn-blockchain" onclick="registerBlockchain()">‚õìÔ∏è Registrar na Blockchain</button>
        <button class="btn btn-secondary" onclick="toggleJSON()">Ver JSON</button>
        <button class="btn btn-secondary" onclick="exportJSON()">Exportar JSON</button>
      </div>
      <div id="blockchainInfo" class="blockchain-info" style="display:none"></div>
      <div class="json-viewer" id="jsonViewer"></div>
      <div class="disclaimer" id="disclaimer"></div>
    </div>
  </div>

<script>
var lastResult = null;

async function runScreening() {
  // Credit check
  if (getCredits() <= 0) { openPaymentModal(); return; }

  const chain = document.getElementById('chain').value;
  const address = document.getElementById('address').value.trim();
  const btn = document.getElementById('btnScreen');
  const status = document.getElementById('statusBar');
  const statusText = document.getElementById('statusText');
  const report = document.getElementById('reportSection');

  if (!address) { alert('Informe o endere√ßo da carteira.'); return; }

  useCredit(); // deduct before
  btn.disabled = true;
  report.classList.remove('show');
  document.getElementById('blockchainInfo').style.display = 'none';
  status.classList.add('show');
  statusText.textContent = 'Consultando OFAC, Explorer, Heur√≠sticas, DeFi Analysis...';

  try {
    const res = await fetch(`/api/screen?chain=${encodeURIComponent(chain)}&address=${encodeURIComponent(address)}`);
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(e) { statusText.textContent = `Erro: servidor retornou resposta invalida (HTTP ${res.status}). Verifique os logs no Vercel.`; btn.disabled = false; setCredits(getCredits()+1); return; }
    if (data.error) { statusText.textContent = `Erro: ${data.error}${data.detail ? ' ‚Äî '+data.detail : ''}`; btn.disabled = false; setCredits(getCredits()+1); return; }
    lastResult = data;
    renderReport(data);
    status.classList.remove('show');
    report.classList.add('show');
    // Auto-save to server if logged in
    saveReportToServer(data).then(function() { loadHistory(); });
  } catch (err) {
    statusText.textContent = `Erro: ${err.message}`;
    setCredits(getCredits()+1); // refund on error
  }
  btn.disabled = false;
}

function renderReport(data) {
  const r = data.report;
  const c = data.compliance || {};
  const d = r.decision;
  const icons = { LOW:'‚úÖ', MEDIUM:'‚ö†Ô∏è', HIGH:'üî¥', CRITICAL:'üö´' };
  const recLabels = { APPROVE:'Aprovar', REVIEW:'Revis√£o Manual (EDD)', BLOCK:'Bloquear Opera√ß√£o' };

  // Header
  document.getElementById('reportHeader').innerHTML = `
    <div>
      <div class="risk-badge risk-${d.level}">${icons[d.level]||'‚ùì'} RISCO ${d.level}</div>
      <p style="margin-top:10px;font-size:13px;color:var(--text-muted)">${d.summary}</p>
    </div>
    <div style="text-align:right">
      <span class="rec rec-${d.recommendation}">${recLabels[d.recommendation]||d.recommendation}</span>
      <div style="margin-top:6px;font-size:12px;color:var(--text-muted)">Score: ${d.score}/100</div>
    </div>`;

  const sa = r.input.address;
  const shortAddr = sa.length>20 ? sa.substring(0,10)+'...'+sa.substring(sa.length-8) : sa;
  document.getElementById('metaRow').innerHTML = `
    <span>ID: <span class="mono">${r.id}</span></span>
    <span>Rede: <span class="mono">${r.input.chain.toUpperCase()}</span></span>
    <span>Endere√ßo: <span class="mono" title="${sa}">${shortAddr}</span></span>
    <span>Data: ${new Date(r.timestamp).toLocaleString('pt-BR')}</span>`;

  // Findings
  const fl = document.getElementById('findingsList');
  fl.innerHTML = r.findings.length === 0
    ? '<div class="no-findings">‚úÖ Nenhum indicador de risco detectado.</div>'
    : r.findings.map(f=>`<div class="finding sev-${f.severity}"><span class="sev-tag t-${f.severity}">${f.severity}</span><div><strong>${f.source}</strong><br/><span style="color:var(--text-muted)">${f.detail}</span></div></div>`).join('');

  // DeFi
  const defi = r.defiAnalysis;
  if (defi) {
    const mx = defi.mixerInteractions?.length||0, bx = defi.bridgeInteractions?.length||0, dx = defi.dexInteractions?.length||0, hp = defi.opaqueHops||0;
    let html = `<div class="defi-grid">
      <div class="defi-card"><div class="num" style="color:${mx>0?'var(--critical)':'var(--green)'}">${mx}</div><div class="lbl">Mixers</div></div>
      <div class="defi-card"><div class="num" style="color:${bx>0?'var(--yellow)':'var(--green)'}">${bx}</div><div class="lbl">Bridges</div></div>
      <div class="defi-card"><div class="num">${dx}</div><div class="lbl">DEX Swaps</div></div>
      <div class="defi-card"><div class="num" style="color:${hp>=3?'var(--red)':'var(--text)'}">${hp}</div><div class="lbl">Saltos Opacos</div></div>
    </div>`;
    if (defi.summary?.patternDescription) html += `<div class="pattern-alert">‚ö†Ô∏è ${defi.summary.patternDescription}</div>`;
    if (mx>0) { html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px"><strong>Mixers detectados:</strong></div>';
      defi.mixerInteractions.forEach(m=>{ html += `<div class="kyc-action" style="border-left-color:var(--critical)"><strong>${m.name}</strong> ‚Äî ${m.direction} ‚Äî <span class="mono">${(m.hash||'').substring(0,16)}...</span></div>`; }); }
    if (bx>0) { html += '<div style="font-size:12px;color:var(--text-muted);margin:8px 0"><strong>Bridges detectadas:</strong></div>';
      defi.bridgeInteractions.forEach(b=>{ html += `<div class="kyc-action" style="border-left-color:var(--yellow)"><strong>${b.name}</strong> ‚Äî ${b.direction}</div>`; }); }
    document.getElementById('defiContent').innerHTML = html;
    document.getElementById('defiSection').style.display = '';
  }

  // Flash Token Detection
  const flash = r.flashAnalysis;
  if (flash?.checked) {
    let fhtml = '';
    if (flash.flashTokensDetected) {
      fhtml += '<div class="flash-alert flash-danger">‚ö†Ô∏è <strong>FLASH TOKEN DETECTADO!</strong> Esta carteira cont√©m token(s) que N√ÉO s√£o do contrato oficial. Estes tokens s√£o falsos ‚Äî n√£o t√™m valor e n√£o podem ser transferidos ou vendidos. <strong>N√ÉO aceitar como pagamento.</strong></div>';
    } else if (flash.officialTokensFound?.length > 0 && flash.suspiciousTokens?.length === 0) {
      fhtml += '<div class="flash-alert flash-safe">‚úÖ Todos os tokens verificados s√£o de contratos oficiais. Nenhum flash token detectado.</div>';
    } else if (flash.suspiciousTokens?.length > 0) {
      fhtml += '<div class="flash-alert flash-warn">‚ö†Ô∏è ' + flash.summary + '</div>';
    } else {
      fhtml += '<div class="flash-alert flash-safe">‚úÖ ' + (flash.summary || 'Verifica√ß√£o conclu√≠da.') + '</div>';
    }

    // Checks detalhados
    if (flash.checks?.length) {
      fhtml += '<div style="margin:12px 0 8px"><div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;font-weight:600;margin-bottom:8px">Verifica√ß√µes Realizadas</div>';
      flash.checks.forEach(c => {
        const icon = c.status==='pass' ? '‚úÖ' : c.status==='fail' ? '‚ùå' : '‚ö†Ô∏è';
        const color = c.status==='pass' ? 'var(--green)' : c.status==='fail' ? 'var(--red)' : 'var(--yellow)';
        fhtml += '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px"><span>' + icon + '</span><span style="flex:1">' + c.name + '</span><span style="color:' + color + ';font-size:11px;font-weight:600">' + c.detail + '</span></div>';
      });
      fhtml += '</div>';
    }

    // Verifica√ß√£o do contrato (holders, VIP)
    if (flash.contractVerification) {
      const cv = flash.contractVerification;
      fhtml += '<div style="margin:8px 0;padding:10px 14px;background:var(--surface-2);border-radius:8px;font-size:11px"><span style="color:var(--text-muted)">Contrato USDT oficial: </span>';
      fhtml += '<span style="color:var(--green);font-weight:700">' + (cv.isVip ? '‚úì Verificado' : 'N√£o verificado') + '</span>';
      if (cv.holders) fhtml += ' <span style="color:var(--text-muted)">| ' + cv.holders.toLocaleString() + ' holders globais</span>';
      fhtml += '</div>';
    }

    // Official tokens
    if (flash.officialTokensFound?.length) {
      fhtml += '<div style="font-size:11px;color:var(--text-muted);margin:12px 0 6px;text-transform:uppercase;letter-spacing:0.06em;font-weight:600">Tokens Oficiais Verificados</div>';
      flash.officialTokensFound.forEach(t => {
        fhtml += '<div class="flash-token-item"><span class="flash-status status-ok">‚úì OFICIAL</span><span style="font-weight:700;color:var(--green)">' + t.symbol + '</span><span style="font-family:monospace;font-size:11px;color:var(--text-muted)">' + (t.balance||'') + '</span><span style="font-size:10px;color:var(--text-muted)">' + t.issuer + '</span></div>';
      });
    }

    // Suspicious tokens
    if (flash.suspiciousTokens?.length) {
      fhtml += '<div style="font-size:11px;color:var(--red);margin:12px 0 6px;text-transform:uppercase;letter-spacing:0.06em;font-weight:600">Tokens Suspeitos / Flash</div>';
      flash.suspiciousTokens.forEach(t => {
        const statusClass = t.status.includes('FLASH') ? 'status-fake' : 'status-warn';
        const statusIcon = t.status.includes('FLASH') ? '‚úó FALSO' : '? VERIFICAR';
        let extra = t.reason||t.status;
        if (t.holders !== null && t.holders !== undefined) extra += ' | ' + t.holders + ' holders';
        fhtml += '<div class="flash-token-item"><span class="flash-status ' + statusClass + '">' + statusIcon + '</span><span style="font-weight:700;color:var(--red)">' + t.symbol + '</span><span style="font-size:11px;color:var(--text-muted)">' + extra + '</span></div>';
      });
    }

    document.getElementById('flashContent').innerHTML = fhtml;
    document.getElementById('flashSection').style.display = '';
  } else {
    document.getElementById('flashSection').style.display = 'none';
  }

  // KYC
  if (c.kyc) {
    let html = `<div style="margin-bottom:12px;font-size:13px"><strong>Status:</strong> <span style="color:var(--red)">${c.kyc.status}</span><br/><strong>N√≠vel:</strong> ${c.kyc.requirement}</div>`;
    if (c.kyc.actions?.length) { html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px"><strong>A√ß√µes obrigat√≥rias:</strong></div>';
      c.kyc.actions.forEach((a,i)=>{ html += `<div class="kyc-action"><strong>${i+1}.</strong> ${a}</div>`; }); }
    if (c.kyc.documentsRequired?.length) { html += '<div style="font-size:12px;color:var(--text-muted);margin:12px 0 8px"><strong>Documentos exigidos:</strong></div><div class="doc-list" style="background:var(--surface-2);border-radius:8px;overflow:hidden">';
      c.kyc.documentsRequired.forEach(d=>{ html += `<div class="doc-item"><span>${d.name}</span><span class="${d.required?'required-tag':'optional-tag'}">${d.required?'OBRIGAT√ìRIO':'Recomendado'}</span></div>`; });
      html += '</div>'; }
    document.getElementById('kycContent').innerHTML = html;
    document.getElementById('kycSection').style.display = '';
  }

  // AML/KYT
  if (c.amlKyt) {
    const a = c.amlKyt;
    const sColors = { ACTIVE:'var(--green)', PARTIAL:'var(--yellow)', INSUFFICIENT:'var(--red)' };
    let html = `<div style="font-size:13px;margin-bottom:12px"><strong>Status:</strong> <span style="color:${sColors[a.status]||'var(--text)'}">${a.status}</span> ‚Äî Cobertura: <strong>${a.coveragePercent}%</strong><br/>${a.recommendation}</div>`;
    if (a.activeProviders?.length) { html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:6px"><strong>Fontes ativas:</strong></div>';
      a.activeProviders.forEach(p=>{ html += `<div style="font-size:12px;padding:4px 0"><span style="color:var(--green)">‚óè</span> ${p}</div>`; }); }
    if (a.inactiveProviders?.length) { html += '<div style="font-size:12px;color:var(--text-muted);margin:8px 0 6px"><strong>N√£o configuradas:</strong></div>';
      a.inactiveProviders.forEach(p=>{ html += `<div style="font-size:12px;padding:4px 0;color:var(--text-muted)">‚óã ${p}</div>`; }); }
    document.getElementById('amlContent').innerHTML = html;
    document.getElementById('amlSection').style.display = '';
  }

  // Regulatory
  if (c.regulatoryCooperation) {
    const reg = c.regulatoryCooperation;
    const sMap = { SAR_REQUIRED:['COMUNICA√á√ÉO AO COAF OBRIGAT√ìRIA','var(--critical)'], ENHANCED_MONITORING:['Monitoramento Refor√ßado','var(--yellow)'], STANDARD:['Procedimento Padr√£o','var(--green)'] };
    const [sLabel,sColor] = sMap[reg.status]||[reg.status,'var(--text)'];
    let html = `<div style="font-size:14px;font-weight:700;color:${sColor};margin-bottom:12px">${sLabel}</div>`;
    if (reg.obligations?.length) {
      html += '<table class="reg-table"><thead><tr><th>Regula√ß√£o</th><th>A√ß√£o</th><th>Prazo</th><th>Prioridade</th></tr></thead><tbody>';
      reg.obligations.forEach(o=>{ html += `<tr><td>${o.regulation}</td><td>${o.action}</td><td>${o.deadline}</td><td><span class="priority-tag pri-${o.priority}">${o.priority}</span></td></tr>`; });
      html += '</tbody></table>'; }
    if (reg.jurisdictions?.length) html += `<div style="font-size:11px;color:var(--text-muted);margin-top:8px"><strong>Jurisdi√ß√µes:</strong> ${reg.jurisdictions.join(', ')}</div>`;
    document.getElementById('regContent').innerHTML = html;
    document.getElementById('regSection').style.display = '';
  }

  // On-chain
  const exp = r.sources.explorer;
  const grid = document.getElementById('onchainGrid');
  if (exp?.enabled && exp?.data) {
    const d = exp.data;
    grid.innerHTML = [
      cell('Saldo',d.balance||'N/A'), cell('Transa√ß√µes',d.txCount??'N/A'),
      cell('Token Txs',d.tokenTxCount??'N/A'), cell('Stablecoin Txs',d.stablecoinTxCount??'N/A'),
      cell('Primeira Tx',d.firstTransaction?new Date(d.firstTransaction).toLocaleDateString('pt-BR'):'N/A'),
      cell('√öltima Tx',d.lastTransaction?new Date(d.lastTransaction).toLocaleDateString('pt-BR'):'N/A'),
      cell('Counterparties',d.uniqueCounterparties??'N/A'), cell('Contrato Int.',d.contractInteractions??'N/A')
    ].join('');
    document.getElementById('onchainSection').style.display = '';

    // Token balances
    const tb = document.getElementById('tokenBalances');
    if (d.tokenBalances?.length) {
      tb.innerHTML = '<div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.06em;font-weight:600">Saldo de Tokens</div>' +
        d.tokenBalances.map(t=>`<span class="token-badge"><span class="sym">${t.symbol}</span><span class="bal">${t.balance||''}</span></span>`).join('');
    } else { tb.innerHTML = ''; }

    // Recent transactions
    if (d.recentTransactions?.length) {
      let txHtml = '';
      d.recentTransactions.slice(0,15).forEach(tx=>{
        const addr = tx.direction==='OUT' ? tx.to : tx.from;
        const shortAddr = addr ? (addr.length>20 ? addr.substring(0,8)+'...'+addr.substring(addr.length-6) : addr) : 'N/A';
        const dateStr = tx.date ? new Date(tx.date).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '';
        txHtml += `<div class="tx-row"><span class="tx-dir dir-${tx.direction}">${tx.direction}</span><span class="tx-addr" title="${addr||''}">${shortAddr}</span><span class="tx-val">${tx.value||''}</span><span class="tx-date">${dateStr}</span></div>`;
      });
      document.getElementById('txList').innerHTML = txHtml;
      document.getElementById('txSection').style.display = '';
    } else { document.getElementById('txSection').style.display = 'none'; }

    // Top counterparties
    if (d.topCounterparties?.length) {
      let cpHtml = '';
      d.topCounterparties.slice(0,10).forEach(cp=>{
        const shortAddr = cp.address.length>20 ? cp.address.substring(0,8)+'...'+cp.address.substring(cp.address.length-6) : cp.address;
        const lastDate = cp.lastSeen ? new Date(cp.lastSeen).toLocaleDateString('pt-BR') : '';
        cpHtml += `<div class="cp-row"><span class="cp-count">${cp.txCount}x</span><span class="tx-addr" title="${cp.address}">${shortAddr}</span><span class="tx-date">${lastDate}</span></div>`;
      });
      document.getElementById('cpList').innerHTML = cpHtml;
      document.getElementById('cpSection').style.display = '';
    } else { document.getElementById('cpSection').style.display = 'none'; }

  } else {
    document.getElementById('onchainSection').style.display = 'none';
    document.getElementById('txSection').style.display = 'none';
    document.getElementById('cpSection').style.display = 'none';
  }

  // Transparency
  if (c.proofOfReserves) {
    const p = c.proofOfReserves;
    const tColors = { TRANSPARENT:'var(--green)', PARTIALLY_OPAQUE:'var(--yellow)', OPAQUE:'var(--red)', UNTRACEABLE:'var(--critical)' };
    const tLabels = { TRANSPARENT:'Transparente', PARTIALLY_OPAQUE:'Parcialmente Opaco', OPAQUE:'Opaco', UNTRACEABLE:'Irrastre√°vel' };
    let html = `<div style="font-size:13px;margin-bottom:8px"><strong>Score:</strong> <span style="color:${tColors[p.status]};font-size:18px;font-weight:700">${p.score}/100</span> ‚Äî <span style="color:${tColors[p.status]}">${tLabels[p.status]||p.status}</span></div>`;
    html += `<div class="transparency-bar"><div class="transparency-fill" style="width:${p.score}%;background:${tColors[p.status]}"></div></div>`;
    html += `<div style="font-size:12px;margin:8px 0"><strong>Rastreabilidade:</strong> ${p.fundTraceability}</div>`;
    if (p.factors?.length) { html += '<div style="font-size:12px;color:var(--text-muted);margin:8px 0"><strong>Fatores:</strong></div>';
      p.factors.forEach(f=>{ const c2 = f.impact<-20?'var(--red)':f.impact<0?'var(--yellow)':'var(--green)';
        html += `<div style="font-size:12px;padding:4px 0">‚óè <strong>${f.factor}</strong> (<span style="color:${c2}">${f.impact>0?'+':''}${f.impact}</span>): ${f.detail}</div>`; }); }
    if (p.recommendation) html += `<div style="font-size:12px;margin-top:8px;padding:10px;background:var(--surface-2);border-radius:8px"><strong>Recomenda√ß√£o:</strong> ${p.recommendation}</div>`;
    document.getElementById('transContent').innerHTML = html;
    document.getElementById('transSection').style.display = '';
  }

  // Audit Trail
  if (c.auditTrail) {
    const at = c.auditTrail;
    let html = '';
    if (at.entries?.length) { at.entries.forEach(e=>{ html += `<div class="audit-entry"><span class="audit-action">${e.action}</span><span style="flex:1;color:var(--text-muted)">${e.detail}</span><span style="color:var(--text-muted);font-size:10px">${e.actor}</span></div>`; }); }
    if (at.reportHash) html += `<div style="font-size:11px;color:var(--text-muted);margin-top:8px"><strong>Hash:</strong> <span class="mono">${at.reportHash}</span> | <strong>Reten√ß√£o:</strong> ${at.retentionPolicy||'5 anos'}</div>`;
    document.getElementById('auditContent').innerHTML = html;
    document.getElementById('auditSection').style.display = '';
  }

  // Sources
  const sg = document.getElementById('sourcesGrid');
  const src = r.sources;
  sg.innerHTML = [
    sourcePill('OFAC/SDN',src.ofac), sourcePill('Explorer',src.explorer),
    sourcePill('Heur√≠sticas',src.heuristics), sourcePill('DeFi Analysis',src.defiAnalysis),
    sourcePill('Flash USDT',src.flashDetection),
    sourcePill('Chainabuse',src.chainabuse), sourcePill('Blocksec',src.blocksec)
  ].join('');

  document.getElementById('disclaimer').textContent = r.disclaimer;
  document.getElementById('jsonViewer').textContent = JSON.stringify(data, null, 2);
  document.getElementById('jsonViewer').classList.remove('show');
}

function cell(label,value) { return `<div class="data-cell"><div class="lbl">${label}</div><div class="val">${value}</div></div>`; }
function sourcePill(name,src) {
  if (!src) return `<div class="source-pill"><span class="indicator inactive"></span>${name} ‚Äî N/A</div>`;
  const s = src.error?'error':src.enabled!==false?'active':'inactive';
  const l = src.error?'Erro':src.enabled!==false?'Ativo':'N√£o config.';
  return `<div class="source-pill"><span class="indicator ${s}"></span>${name} ‚Äî ${l}</div>`;
}

async function downloadPDF() {
  if (!lastResult) return;
  const btn = event.target; btn.disabled = true; btn.textContent = 'Gerando PDF...';
  try {
    const res = await fetch('/api/report/pdf', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(lastResult) });
    if (!res.ok) { const t = await res.text(); throw new Error(`HTTP ${res.status}: ${t.substring(0,100)}`); }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = `relatorio-aml-${lastResult.report.id}.pdf`;
    a.click(); URL.revokeObjectURL(url);
  } catch (err) { alert('Erro ao gerar PDF: '+err.message); }
  btn.disabled = false; btn.textContent = 'Baixar Relat√≥rio PDF';
}

function toggleJSON() { document.getElementById('jsonViewer').classList.toggle('show'); }
function exportJSON() {
  if (!lastResult) return;
  const blob = new Blob([JSON.stringify(lastResult,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `aml-report-${lastResult.report.id}.json`; a.click();
}

document.getElementById('address').addEventListener('keydown',e=>{ if(e.key==='Enter') runScreening(); });

// =============================================
// AUTH + CREDITS + PERSISTENCE (Supabase or Local)
// =============================================
var authToken = '';
try { authToken = localStorage.getItem('aml_token') || ''; } catch(e) {}
var authUser = null;
var supabaseMode = false;
var selectedPackage = 'starter';

function getCredits() {
  try {
    var c = parseInt(localStorage.getItem('aml_credits') || '1');
    return isNaN(c) ? 1 : c;
  } catch(e) { return 1; }
}
function setCredits(n) {
  try { localStorage.setItem('aml_credits', String(n)); } catch(e) {}
  updateCreditDisplay();
}
function useCredit() {
  var c = getCredits();
  if (c <= 0) return false;
  setCredits(c - 1);
  if (authToken && supabaseMode) {
    fetch('/api/credits', { method: 'POST', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + authToken }, body: JSON.stringify({ action: 'use' }) }).catch(function(){});
  }
  return true;
}
function updateCreditDisplay() {
  var c = getCredits();
  var el = document.getElementById('creditCount');
  if (el) {
    el.textContent = c;
    el.style.color = c > 0 ? 'var(--accent)' : 'var(--red)';
    el.style.background = c > 0 ? 'var(--accent-dim)' : 'rgba(248,113,113,.12)';
  }
}

// Run immediately (synchronous)
updateCreditDisplay();

// Auth init (async, non-blocking, won't break if Supabase isn't configured)
setTimeout(function() {
  if (!authToken) return;
  fetch('/api/auth', { headers: { Authorization: 'Bearer ' + authToken } })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.authenticated) {
        authUser = data.user;
        supabaseMode = true;
        showLoggedIn();
        return fetch('/api/credits', { headers: { Authorization: 'Bearer ' + authToken } });
      } else {
        authToken = '';
        try { localStorage.removeItem('aml_token'); } catch(e) {}
      }
    })
    .then(function(r) { if (r) return r.json(); })
    .then(function(data) {
      if (data && data.credits !== undefined && data.credits >= 0) {
        setCredits(data.credits);
      }
      loadHistory();
    })
    .catch(function() { /* Supabase not available ‚Äî local mode OK */ });
}, 100);
async function refreshCredits() {
  if (!authToken || !supabaseMode) return;
  try {
    var res = await fetch('/api/credits', { headers: { Authorization: 'Bearer ' + authToken } });
    var data = await res.json();
    if (data.credits !== undefined && data.credits >= 0) {
      setCredits(data.credits);
    }
  } catch(e) {}
}

// --- Auth UI ---
function showLoggedIn() {
  var bar = document.getElementById('authBar');
  if (bar && authUser) {
    bar.innerHTML = '<span class="user-email">' + (authUser.email||'').split('@')[0] + '</span>' +
      '<button class="btn btn-secondary" onclick="logout()" style="padding:5px 10px;font-size:10px">Sair</button>';
  }
}
function logout() {
  authToken = ''; authUser = null;
  localStorage.removeItem('aml_token');
  document.getElementById('authBar').innerHTML = '<button class="btn btn-secondary" onclick="openAuthModal()" id="authBtn" style="padding:7px 14px;font-size:11px">Entrar</button>';
  document.getElementById('historyPanel').style.display = 'none';
}

var authAction = 'login';
function openAuthModal() { document.getElementById('authModal').classList.add('show'); }
function closeAuthModal() { document.getElementById('authModal').classList.remove('show'); }
document.getElementById('authModal').addEventListener('click', function(e) { if (e.target === this) closeAuthModal(); });

function setAuthTab(action) {
  authAction = action;
  document.querySelectorAll('.auth-tab').forEach(function(t,i) { t.classList.toggle('active', (i===0 && action==='login') || (i===1 && action==='register')); });
  document.getElementById('authSubmit').textContent = action === 'login' ? 'Entrar' : 'Criar Conta';
  document.getElementById('authMsg').innerHTML = '';
}

async function submitAuth() {
  var email = document.getElementById('authEmail').value.trim();
  var password = document.getElementById('authPassword').value;
  var msgEl = document.getElementById('authMsg');
  var btn = document.getElementById('authSubmit');
  if (!email || !password) { msgEl.className = 'auth-msg error'; msgEl.textContent = 'Preencha email e senha.'; return; }
  btn.disabled = true; btn.textContent = 'Aguarde...';
  msgEl.innerHTML = '';

  try {
    var res = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: authAction, email: email, password: password })
    });
    var data = await res.json();
    if (data.error) { msgEl.className = 'auth-msg error'; msgEl.textContent = data.error; }
    else if (data.success) {
      if (data.session && data.session.access_token) {
        authToken = data.session.access_token;
        localStorage.setItem('aml_token', authToken);
        authUser = data.user;
        supabaseMode = true;
        showLoggedIn();
        await refreshCredits();
        await loadHistory();
        closeAuthModal();
        msgEl.className = 'auth-msg success'; msgEl.textContent = 'Conectado!';
      } else {
        msgEl.className = 'auth-msg success'; msgEl.textContent = data.message || 'Conta criada! Verifique seu email e fa√ßa login.';
      }
    }
  } catch(err) { msgEl.className = 'auth-msg error'; msgEl.textContent = 'Erro: ' + err.message; }
  btn.disabled = false; btn.textContent = authAction === 'login' ? 'Entrar' : 'Criar Conta';
}

// --- Report History ---
async function loadHistory() {
  if (!authToken || !supabaseMode) return;
  try {
    var res = await fetch('/api/reports', { headers: { Authorization: 'Bearer ' + authToken } });
    var data = await res.json();
    var panel = document.getElementById('historyPanel');
    var list = document.getElementById('historyList');
    if (!data.reports || !data.reports.length) { panel.style.display = 'none'; return; }

    panel.style.display = 'block';
    document.getElementById('histCount').textContent = '(' + data.reports.length + ')';
    list.innerHTML = data.reports.map(function(r) {
      var addr = r.address || '';
      var short = addr.length > 20 ? addr.substring(0,8) + '...' + addr.substring(addr.length-6) : addr;
      var dt = r.created_at ? new Date(r.created_at).toLocaleDateString('pt-BR') : '';
      return '<div class="hist-item" onclick="loadReport(\'' + (r.report_id||'') + '\')">' +
        '<span class="hist-risk ' + (r.risk_level||'') + '">' + (r.risk_level||'?') + '</span>' +
        '<span class="hist-addr">' + short + '</span>' +
        '<span class="hist-chain">' + (r.chain||'') + '</span>' +
        (r.blockchain_cert ? '<span class="hist-bc">&#9939;</span>' : '') +
        '<span class="hist-date">' + dt + '</span></div>';
    }).join('');
  } catch(e) {}
}

async function loadReport(reportId) {
  if (!authToken) return;
  try {
    var res = await fetch('/api/reports?id=' + encodeURIComponent(reportId), { headers: { Authorization: 'Bearer ' + authToken } });
    var data = await res.json();
    if (data.report && data.report.data_json) {
      lastResult = typeof data.report.data_json === 'string' ? JSON.parse(data.report.data_json) : data.report.data_json;
      renderReport(lastResult);
      document.getElementById('reportSection').classList.add('show');
      document.getElementById('reportSection').scrollIntoView({ behavior: 'smooth' });
    }
  } catch(e) {}
}

async function saveReportToServer(resultData) {
  if (!authToken || !supabaseMode) return;
  try {
    await fetch('/api/reports', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + authToken },
      body: JSON.stringify(resultData)
    });
  } catch(e) {}
}

// =============================================
// PAGAMENTO USDT
// =============================================
var currentPayment = null;
var paymentCheckInterval = null;

function selectPackage(pkgId, el) {
  selectedPackage = pkgId;
  document.querySelectorAll('.pkg-card').forEach(function(c) { c.classList.remove('selected'); });
  if (el) el.classList.add('selected');
}

function openPaymentModal() {
  document.getElementById('paymentModal').classList.add('show');
  // Reset content
  var content = document.getElementById('paymentContent');
  content.innerHTML =
    '<div class="pkg-grid">' +
    '<div class="pkg-card' + (selectedPackage==='starter' ? ' selected' : '') + '" onclick="selectPackage(\'starter\',this)">' +
    '<div class="pkg-price">1 USDT</div><div class="pkg-credits">15 consultas</div><div class="pkg-label">~R$ 0,40/relat√≥rio</div></div>' +
    '<div class="pkg-card' + (selectedPackage==='pro' ? ' selected' : '') + '" onclick="selectPackage(\'pro\',this)">' +
    '<div class="pkg-price">10 USDT</div><div class="pkg-credits">200 consultas</div><div class="pkg-label">~R$ 0,30/relat√≥rio</div></div>' +
    '</div>' +
    '<div style="text-align:center"><button class="btn btn-primary" onclick="generatePayment()" style="padding:12px 28px;font-size:14px">Gerar C√≥digo de Pagamento</button></div>';
}
function closePaymentModal() {
  document.getElementById('paymentModal').classList.remove('show');
  if (paymentCheckInterval) { clearInterval(paymentCheckInterval); paymentCheckInterval = null; }
}
document.getElementById('paymentModal').addEventListener('click', function(e) {
  if (e.target === this) closePaymentModal();
});

async function generatePayment() {
  var content = document.getElementById('paymentContent');
  content.innerHTML = '<div style="text-align:center;padding:20px"><div class="spinner" style="margin:0 auto"></div><p style="margin-top:12px;font-size:12px;color:var(--text-muted)">Gerando c√≥digo...</p></div>';

  try {
    var session = localStorage.getItem('aml_session') || Date.now().toString();
    localStorage.setItem('aml_session', session);

    var res = await fetch('/api/payment/verify?session=' + encodeURIComponent(session) + '&package=' + selectedPackage);
    var data = await res.json();

    if (!data.success) throw new Error(data.error || 'Erro');
    currentPayment = data.payment;

    content.innerHTML =
      '<div class="pay-amount">' + currentPayment.amount + ' USDT</div>' +
      '<p style="text-align:center;font-size:12px;color:var(--text-muted);margin-bottom:16px">Envie <strong>exatamente</strong> este valor em USDT TRC-20 ¬∑ <strong>' + currentPayment.package.credits + ' consultas</strong></p>' +
      '<div class="wallet-box" onclick="navigator.clipboard.writeText(\'' + currentPayment.wallet + '\').then(function(){document.querySelector(\'.wallet-box\').style.borderColor=\'var(--green)\'})">' +
      currentPayment.wallet +
      '<br><span style="font-size:10px;color:var(--text-muted);font-family:\'DM Sans\',sans-serif">Clique para copiar</span></div>' +
      '<div class="pay-step"><div class="pay-step-num">1</div><div class="pay-step-text"><strong>Copie o endere√ßo</strong> e o valor exato</div></div>' +
      '<div class="pay-step"><div class="pay-step-num">2</div><div class="pay-step-text"><strong>Envie USDT TRC-20</strong> de qualquer carteira</div></div>' +
      '<div class="pay-step"><div class="pay-step-num">3</div><div class="pay-step-text"><strong>Aguarde ~30s</strong> ‚Äî verifica√ß√£o autom√°tica via TronScan</div></div>' +
      '<div id="payStatus" class="pay-status checking">Aguardando pagamento... Verificando a cada 30s</div>' +
      '<button class="btn btn-primary" onclick="checkPaymentNow()" style="width:100%;margin-top:8px">Verificar Agora</button>';

    paymentCheckInterval = setInterval(checkPaymentNow, 30000);
  } catch(err) {
    content.innerHTML = '<div class="pay-status error">Erro: ' + err.message + '</div>';
  }
}

async function checkPaymentNow() {
  if (!currentPayment) return;
  var statusEl = document.getElementById('payStatus');
  if (statusEl) statusEl.className = 'pay-status checking';
  if (statusEl) statusEl.textContent = 'Verificando no TronScan...';

  try {
    var headers = { 'Content-Type': 'application/json' };
    if (authToken) headers.Authorization = 'Bearer ' + authToken;

    var res = await fetch('/api/payment/verify', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({ amount: currentPayment.amount })
    });
    var data = await res.json();

    if (data.verified) {
      if (paymentCheckInterval) { clearInterval(paymentCheckInterval); paymentCheckInterval = null; }
      var granted = data.creditsGranted || currentPayment.package.credits || 15;
      setCredits(getCredits() + granted);
      // Refresh from server if logged in
      if (authToken && supabaseMode) await refreshCredits();
      if (statusEl) {
        statusEl.className = 'pay-status success';
        statusEl.innerHTML = 'Pagamento confirmado! +' + granted + ' consultas adicionadas.<br><span style="font-size:11px">TX: ' + (data.txHash||'').substring(0,20) + '...</span>';
      }
      setTimeout(closePaymentModal, 3000);
    } else {
      if (statusEl) {
        statusEl.className = 'pay-status checking';
        statusEl.textContent = 'Pagamento n√£o encontrado ainda. Verificando novamente em 30s...';
      }
    }
  } catch(err) {
    if (statusEl) { statusEl.className = 'pay-status error'; statusEl.textContent = 'Erro: ' + err.message; }
  }
  }
}

// =============================================
// REGISTRO BLOCKCHAIN (IBEDIS Token)
// =============================================
async function registerBlockchain() {
  if (!lastResult) return;
  const btn = event.target; btn.disabled = true; btn.textContent = '‚õìÔ∏è Registrando na IBEDIS Token...';
  const infoEl = document.getElementById('blockchainInfo');
  infoEl.style.display = 'block';
  infoEl.innerHTML = '<div style="text-align:center;padding:12px"><div class="spinner" style="display:inline-block"></div> Registrando na blockchain via IBEDIS Token...</div>';

  try {
    const res = await fetch('/api/blockchain/register', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(lastResult)
    });
    const data = await res.json();

    if (data.success && data.blockchain) {
      const bc = data.blockchain;
      let html = `
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <span style="color:var(--green);font-weight:700;font-size:13px">‚úÖ Registrado na Blockchain</span>
          ${bc.certificado ? '<span style="background:rgba(52,211,153,.1);color:var(--green);padding:3px 10px;border-radius:6px;font-family:\'JetBrains Mono\',monospace;font-size:10px;font-weight:600">' + bc.certificado + '</span>' : ''}
        </div>
        <div style="color:var(--text-muted);font-size:11px;line-height:2">
          <strong>Hash SHA-256:</strong> <span style="font-family:'JetBrains Mono',monospace;font-size:10px">${bc.hash || ''}</span><br>`;

      if (bc.verificacao_url) html += `<strong>Certificado:</strong> <a href="${bc.verificacao_url}" target="_blank" style="color:var(--accent)">${bc.verificacao_url}</a><br>`;
      if (bc.ipfs?.document_url) html += `<strong>IPFS Doc:</strong> <a href="${bc.ipfs.document_url}" target="_blank" style="color:var(--accent)">Ver no IPFS</a>`;
      if (bc.ipfs?.metadata_url) html += ` ¬∑ <a href="${bc.ipfs.metadata_url}" target="_blank" style="color:var(--accent)">Metadados IPFS</a><br>`;
      if (bc.files?.stamped_url) html += `<strong>PDF Carimbado:</strong> <a href="${bc.files.stamped_url}" target="_blank" style="color:var(--accent)">Baixar PDF com carimbo blockchain</a><br>`;
      if (bc.files?.certificate_url) html += `<strong>Certificado PDF:</strong> <a href="${bc.files.certificate_url}" target="_blank" style="color:var(--accent)">Baixar certificado</a><br>`;

      html += `<strong>Plataforma:</strong> <a href="https://token.ibedis.com.br" target="_blank" style="color:var(--accent)">IBEDIS Token ‚Äî Polygon Blockchain</a>`;
      html += '</div>';
      infoEl.innerHTML = html;
    } else {
      infoEl.innerHTML = '<span style="color:var(--yellow)">‚ö†Ô∏è ' + (data.error || 'Registro pendente ‚Äî tente novamente') + '</span>';
    }
  } catch(err) {
    infoEl.innerHTML = '<span style="color:var(--red)">Erro de conex√£o: ' + err.message + '</span>';
  }
  btn.disabled = false; btn.textContent = '‚õìÔ∏è Registrar na Blockchain';
}
</script>
  <!-- Payment Modal -->
  <div class="modal-overlay" id="paymentModal">
    <div class="modal">
      <h2>Comprar Cr√©ditos <button class="modal-close" onclick="closePaymentModal()">&times;</button></h2>
      <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Pagamento em USDT TRC-20 com verifica√ß√£o autom√°tica via TronScan.</p>
      <div id="paymentContent">
        <div class="pkg-grid">
          <div class="pkg-card selected" onclick="selectPackage('starter',this)">
            <div class="pkg-price">1 USDT</div>
            <div class="pkg-credits">15 consultas</div>
            <div class="pkg-label">~R$ 0,40/relat√≥rio</div>
          </div>
          <div class="pkg-card" onclick="selectPackage('pro',this)">
            <div class="pkg-price">10 USDT</div>
            <div class="pkg-credits">200 consultas</div>
            <div class="pkg-label">~R$ 0,30/relat√≥rio</div>
          </div>
        </div>
        <div style="text-align:center">
          <button class="btn btn-primary" onclick="generatePayment()" style="padding:12px 28px;font-size:14px">Gerar C√≥digo de Pagamento</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modal-overlay" id="authModal">
    <div class="modal">
      <h2>Acessar Conta <button class="modal-close" onclick="closeAuthModal()">&times;</button></h2>
      <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">Crie uma conta para manter seus cr√©ditos e relat√≥rios salvos em qualquer dispositivo.</p>
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="setAuthTab('login')">Entrar</button>
        <button class="auth-tab" onclick="setAuthTab('register')">Criar Conta</button>
      </div>
      <input type="email" class="auth-input" id="authEmail" placeholder="E-mail">
      <input type="password" class="auth-input" id="authPassword" placeholder="Senha (m√≠n. 6 caracteres)">
      <button class="btn btn-primary" id="authSubmit" onclick="submitAuth()" style="width:100%;justify-content:center">Entrar</button>
      <div id="authMsg"></div>
    </div>
  </div>

</body>
</html>
