<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AML Wallet Screening ‚Äî Compliance Report</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%230891b2'/><text x='8' y='24' font-size='22' fill='white'>A</text></svg>" type="image/svg+xml" />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0a0e17; --surface: #111827; --surface-2: #1a2236; --border: #1e2a3e;
      --text: #e2e8f0; --text-muted: #7a8ba7; --accent: #22d3ee; --accent-dim: rgba(34,211,238,0.12);
      --green: #34d399; --yellow: #fbbf24; --red: #f87171; --critical: #ef4444; --radius: 10px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    .header { padding:20px 28px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:14px; }
    .logo { width:34px; height:34px; background:linear-gradient(135deg,var(--accent),#6366f1); border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:16px; color:#000; }
    .header h1 { font-size:17px; font-weight:600; letter-spacing:-0.02em; }
    .badge { background:var(--accent-dim); color:var(--accent); padding:3px 10px; border-radius:16px; font-size:10px; font-weight:700; letter-spacing:0.06em; text-transform:uppercase; }
    .container { max-width:1100px; margin:0 auto; padding:28px; }
    .input-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:24px; margin-bottom:20px; }
    .input-card h2 { font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:16px; }
    .form-row { display:flex; gap:12px; flex-wrap:wrap; align-items:end; }
    label { display:block; font-size:11px; font-weight:500; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:5px; }
    select, input[type="text"] { width:100%; padding:11px 12px; background:var(--surface-2); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:'JetBrains Mono',monospace; font-size:13px; outline:none; transition:border-color 0.2s; }
    select:focus, input:focus { border-color:var(--accent); }
    .btn { padding:11px 22px; border:none; border-radius:8px; font-family:'DM Sans',sans-serif; font-size:13px; font-weight:700; cursor:pointer; transition:transform 0.15s,opacity 0.2s; white-space:nowrap; }
    .btn:hover { transform:translateY(-1px); opacity:0.9; }
    .btn:disabled { opacity:0.4; cursor:wait; }
    .btn-primary { background:linear-gradient(135deg,var(--accent),#6366f1); color:#000; }
    .btn-secondary { background:var(--surface-2); border:1px solid var(--border); color:var(--text); font-weight:600; font-size:12px; }
    .btn-pdf { background:linear-gradient(135deg,#ef4444,#dc2626); color:#fff; }
    .status-bar { padding:14px 20px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:20px; font-size:13px; color:var(--text-muted); display:none; align-items:center; gap:10px; }
    .status-bar.show { display:flex; }
    .spinner { width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .report { display:none; }
    .report.show { display:block; }
    .risk-badge { display:inline-flex; align-items:center; gap:10px; padding:12px 24px; border-radius:8px; font-size:20px; font-weight:700; }
    .risk-LOW { background:rgba(52,211,153,0.1); color:var(--green); border:1px solid rgba(52,211,153,0.25); }
    .risk-MEDIUM { background:rgba(251,191,36,0.1); color:var(--yellow); border:1px solid rgba(251,191,36,0.25); }
    .risk-HIGH { background:rgba(248,113,113,0.1); color:var(--red); border:1px solid rgba(248,113,113,0.25); }
    .risk-CRITICAL { background:rgba(239,68,68,0.12); color:var(--critical); border:2px solid rgba(239,68,68,0.4); }
    .rec { font-size:12px; font-weight:700; padding:6px 14px; border-radius:6px; text-transform:uppercase; letter-spacing:0.06em; }
    .rec-APPROVE { background:rgba(52,211,153,0.12); color:var(--green); }
    .rec-REVIEW { background:rgba(251,191,36,0.12); color:var(--yellow); }
    .rec-BLOCK { background:rgba(248,113,113,0.12); color:var(--red); }
    .meta-row { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:16px; font-size:12px; color:var(--text-muted); }
    .mono { font-family:'JetBrains Mono',monospace; color:var(--accent); font-size:11px; }
    .section { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:20px; margin-bottom:14px; }
    .section h3 { font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.08em; margin-bottom:14px; display:flex; align-items:center; gap:8px; }
    .dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
    .finding { padding:12px 16px; border-radius:8px; margin-bottom:8px; font-size:13px; line-height:1.5; display:flex; gap:12px; align-items:flex-start; }
    .finding.sev-CRITICAL { background:rgba(239,68,68,0.08); border-left:3px solid var(--critical); }
    .finding.sev-HIGH { background:rgba(248,113,113,0.08); border-left:3px solid var(--red); }
    .finding.sev-MEDIUM { background:rgba(251,191,36,0.06); border-left:3px solid var(--yellow); }
    .finding.sev-LOW { background:rgba(52,211,153,0.06); border-left:3px solid var(--green); }
    .sev-tag { font-size:10px; font-weight:700; padding:2px 8px; border-radius:4px; white-space:nowrap; text-transform:uppercase; }
    .sev-tag.t-CRITICAL { background:var(--critical); color:#fff; }
    .sev-tag.t-HIGH { background:var(--red); color:#fff; }
    .sev-tag.t-MEDIUM { background:var(--yellow); color:#000; }
    .sev-tag.t-LOW { background:var(--green); color:#000; }
    .data-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:10px; }
    .data-cell { background:var(--surface-2); padding:12px; border-radius:8px; }
    .data-cell .lbl { font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:4px; }
    .data-cell .val { font-family:'JetBrains Mono',monospace; font-size:14px; font-weight:600; word-break:break-all; }
    .sources-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:10px; }
    .source-pill { display:flex; align-items:center; gap:8px; padding:10px 14px; background:var(--surface-2); border-radius:8px; font-size:12px; }
    .indicator { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
    .indicator.active { background:var(--green); }
    .indicator.inactive { background:var(--text-muted); opacity:0.4; }
    .indicator.error { background:var(--red); }
    .defi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:12px; }
    .defi-card { background:var(--surface-2); padding:14px; border-radius:8px; text-align:center; }
    .defi-card .num { font-size:28px; font-weight:700; font-family:'JetBrains Mono',monospace; }
    .defi-card .lbl { font-size:10px; color:var(--text-muted); text-transform:uppercase; margin-top:4px; }
    .pattern-alert { padding:12px 16px; background:rgba(248,113,113,0.08); border:1px solid rgba(248,113,113,0.3); border-radius:8px; color:var(--red); font-size:13px; font-weight:600; margin-bottom:12px; }
    .kyc-action { padding:10px 14px; background:var(--surface-2); border-radius:8px; margin-bottom:6px; font-size:13px; line-height:1.5; border-left:3px solid var(--accent); }
    .doc-list { margin-top:10px; }
    .doc-item { display:flex; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--border); font-size:12px; }
    .doc-item:last-child { border-bottom:none; }
    .required-tag { color:var(--red); font-weight:700; font-size:10px; text-transform:uppercase; }
    .optional-tag { color:var(--text-muted); font-size:10px; }
    .reg-table { width:100%; border-collapse:collapse; font-size:12px; }
    .reg-table th { background:var(--surface-2); padding:10px; text-align:left; font-weight:600; color:var(--text-muted); text-transform:uppercase; font-size:10px; letter-spacing:0.06em; }
    .reg-table td { padding:10px; border-bottom:1px solid var(--border); }
    .priority-tag { font-size:10px; font-weight:700; padding:2px 8px; border-radius:4px; }
    .pri-IMEDIATA,.pri-CRITICA,.pri-CR√çTICA { background:rgba(248,113,113,0.15); color:var(--red); }
    .pri-ALTA { background:rgba(251,191,36,0.15); color:var(--yellow); }
    .pri-PADR√ÉO { background:rgba(52,211,153,0.1); color:var(--green); }
    .transparency-bar { height:12px; background:var(--surface-2); border-radius:6px; overflow:hidden; margin:8px 0; }
    .transparency-fill { height:100%; border-radius:6px; transition:width 0.5s; }
    .audit-entry { display:flex; gap:12px; padding:8px 0; border-bottom:1px solid var(--border); font-size:11px; }
    .audit-entry:last-child { border-bottom:none; }
    .audit-action { font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--accent); min-width:140px; }
    .actions { display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
    .json-viewer { background:var(--surface-2); padding:16px; border-radius:8px; font-family:'JetBrains Mono',monospace; font-size:11px; line-height:1.6; max-height:400px; overflow:auto; white-space:pre-wrap; display:none; margin-top:12px; }
    .json-viewer.show { display:block; }
    .disclaimer { margin-top:20px; padding:14px; background:rgba(251,191,36,0.06); border:1px solid rgba(251,191,36,0.15); border-radius:8px; font-size:11px; color:var(--yellow); line-height:1.5; }
    .tx-row { display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid var(--border); font-size:12px; }
    .tx-row:last-child { border-bottom:none; }
    .tx-dir { font-size:10px; font-weight:700; padding:2px 8px; border-radius:4px; min-width:32px; text-align:center; }
    .tx-dir.dir-IN { background:rgba(52,211,153,0.12); color:var(--green); }
    .tx-dir.dir-OUT { background:rgba(248,113,113,0.12); color:var(--red); }
    .tx-addr { font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--accent); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .tx-val { font-family:'JetBrains Mono',monospace; font-size:11px; font-weight:600; white-space:nowrap; }
    .tx-date { font-size:10px; color:var(--text-muted); white-space:nowrap; }
    .cp-row { display:flex; align-items:center; gap:10px; padding:8px 12px; border-bottom:1px solid var(--border); font-size:12px; }
    .cp-row:last-child { border-bottom:none; }
    .cp-count { background:var(--surface-2); padding:2px 8px; border-radius:4px; font-size:11px; font-weight:700; font-family:'JetBrains Mono',monospace; color:var(--accent); }
    .token-badge { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; background:var(--surface-2); border-radius:8px; font-size:12px; margin:4px; }
    .token-badge .sym { font-weight:700; color:var(--accent); }
    .token-badge .bal { font-family:'JetBrains Mono',monospace; }
    .flash-alert { padding:14px 18px; border-radius:10px; margin-bottom:12px; font-size:13px; line-height:1.6; }
    .flash-alert.flash-danger { background:rgba(220,38,38,0.12); border:2px solid var(--red); color:var(--red); }
    .flash-alert.flash-safe { background:rgba(5,150,105,0.08); border:1px solid rgba(5,150,105,0.3); color:var(--green); }
    .flash-alert.flash-warn { background:rgba(217,119,6,0.08); border:1px solid rgba(217,119,6,0.3); color:var(--yellow); }
    .flash-token-item { display:flex; align-items:center; gap:10px; padding:10px 14px; border-bottom:1px solid var(--border); font-size:12px; }
    .flash-token-item:last-child { border-bottom:none; }
    .flash-status { font-size:10px; font-weight:700; padding:3px 10px; border-radius:5px; white-space:nowrap; }
    .flash-status.status-ok { background:rgba(5,150,105,0.12); color:var(--green); }
    .flash-status.status-fake { background:rgba(220,38,38,0.15); color:var(--red); }
    .flash-status.status-warn { background:rgba(217,119,6,0.12); color:var(--yellow); }
    .no-findings { padding:20px; text-align:center; color:var(--green); font-size:14px; }
    @media (max-width:700px) {
      .form-row,.defi-grid { flex-direction:column; grid-template-columns:1fr 1fr; }
      .data-grid,.sources-grid { grid-template-columns:1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">A</div>
    <h1>AML Wallet Screening</h1>
    <span class="badge">v2.0 Compliance</span>
  </div>

  <div class="container">
    <!-- INPUT -->
    <div class="input-card">
      <h2>Consultar Carteira</h2>
      <div class="form-row">
        <div style="flex:0 0 180px">
          <label for="chain">Rede</label>
          <select id="chain">
            <option value="ethereum">Ethereum (ETH/ERC-20)</option>
            <option value="tron">TRON (TRC-20 / USDT)</option>
            <option value="bsc">BSC (BNB/BEP-20)</option>
            <option value="polygon">Polygon (MATIC)</option>
            <option value="bitcoin">Bitcoin (BTC)</option>
          </select>
        </div>
        <div style="flex:1;min-width:200px">
          <label for="address">Endere√ßo da carteira</label>
          <input type="text" id="address" placeholder="0x... / T... / bc1... / 1..." spellcheck="false" autocomplete="off" />
        </div>
        <button class="btn btn-primary" id="btnScreen" onclick="runScreening()">Analisar Risco</button>
      </div>
    </div>

    <div class="status-bar" id="statusBar"><div class="spinner"></div><span id="statusText"></span></div>

    <!-- REPORT -->
    <div class="report" id="reportSection">
      <div id="reportHeader" style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;margin-bottom:16px"></div>
      <div class="meta-row" id="metaRow"></div>

      <!-- Findings -->
      <div class="section" id="findingsSection"><h3><span class="dot" style="background:var(--red)"></span> Indicadores de Risco</h3><div id="findingsList"></div></div>

      <!-- DeFi Analysis -->
      <div class="section" id="defiSection" style="display:none"><h3><span class="dot" style="background:var(--critical)"></span> An√°lise DeFi ‚Äî Mixer / Bridge / DEX / Saltos Opacos</h3><div id="defiContent"></div></div>

      <!-- Flash Token Detection -->
      <div class="section" id="flashSection" style="display:none"><h3><span class="dot" style="background:var(--yellow)"></span> Verifica√ß√£o Flash USDT / Tokens Falsos</h3><div id="flashContent"></div></div>

      <!-- KYC -->
      <div class="section" id="kycSection" style="display:none"><h3><span class="dot" style="background:var(--accent)"></span> KYC ‚Äî Due Diligence Obrigat√≥ria</h3><div id="kycContent"></div></div>

      <!-- AML/KYT -->
      <div class="section" id="amlSection" style="display:none"><h3><span class="dot" style="background:var(--green)"></span> AML/KYT ‚Äî Monitoramento Ativo</h3><div id="amlContent"></div></div>

      <!-- Regulatory -->
      <div class="section" id="regSection" style="display:none"><h3><span class="dot" style="background:var(--yellow)"></span> Coopera√ß√£o Regulat√≥ria</h3><div id="regContent"></div></div>

      <!-- On-chain Data -->
      <div class="section" id="onchainSection"><h3><span class="dot" style="background:var(--green)"></span> Monitoramento On-Chain</h3><div class="data-grid" id="onchainGrid"></div><div id="tokenBalances" style="margin-top:12px"></div></div>

      <!-- Recent Transactions -->
      <div class="section" id="txSection" style="display:none"><h3><span class="dot" style="background:var(--accent)"></span> Transa√ß√µes Recentes</h3><div id="txList"></div></div>

      <!-- Top Counterparties -->
      <div class="section" id="cpSection" style="display:none"><h3><span class="dot" style="background:var(--text-muted)"></span> Principais Counterparties</h3><div id="cpList"></div></div>

      <!-- Transparency -->
      <div class="section" id="transSection" style="display:none"><h3><span class="dot" style="background:var(--text-muted)"></span> Prova de Reservas / Transpar√™ncia</h3><div id="transContent"></div></div>

      <!-- Audit Trail -->
      <div class="section" id="auditSection" style="display:none"><h3><span class="dot" style="background:var(--accent)"></span> Trilha de Auditoria</h3><div id="auditContent"></div></div>

      <!-- Sources -->
      <div class="section"><h3><span class="dot" style="background:var(--text-muted)"></span> Fontes Consultadas</h3><div class="sources-grid" id="sourcesGrid"></div></div>

      <!-- Actions -->
      <div class="actions">
        <button class="btn btn-pdf" onclick="downloadPDF()">Baixar Relat√≥rio PDF</button>
        <button class="btn btn-secondary" onclick="toggleJSON()">Ver JSON</button>
        <button class="btn btn-secondary" onclick="exportJSON()">Exportar JSON</button>
      </div>
      <div class="json-viewer" id="jsonViewer"></div>
      <div class="disclaimer" id="disclaimer"></div>
    </div>
  </div>

<script>
let lastResult = null;

async function runScreening() {
  const chain = document.getElementById('chain').value;
  const address = document.getElementById('address').value.trim();
  const btn = document.getElementById('btnScreen');
  const status = document.getElementById('statusBar');
  const statusText = document.getElementById('statusText');
  const report = document.getElementById('reportSection');

  if (!address) { alert('Informe o endere√ßo da carteira.'); return; }

  btn.disabled = true;
  report.classList.remove('show');
  status.classList.add('show');
  statusText.textContent = 'Consultando OFAC, Explorer, Heur√≠sticas, DeFi Analysis...';

  try {
    const res = await fetch(`/api/screen?chain=${encodeURIComponent(chain)}&address=${encodeURIComponent(address)}`);
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(e) { statusText.textContent = `Erro: servidor retornou resposta invalida (HTTP ${res.status}). Verifique os logs no Vercel.`; btn.disabled = false; return; }
    if (data.error) { statusText.textContent = `Erro: ${data.error}${data.detail ? ' ‚Äî '+data.detail : ''}`; btn.disabled = false; return; }
    lastResult = data;
    renderReport(data);
    status.classList.remove('show');
    report.classList.add('show');
  } catch (err) {
    statusText.textContent = `Erro: ${err.message}`;
  }
  btn.disabled = false;
}

function renderReport(data) {
  const r = data.report;
  const c = data.compliance || {};
  const d = r.decision;
  const icons = { LOW:'‚úÖ', MEDIUM:'‚ö†Ô∏è', HIGH:'üî¥', CRITICAL:'üö´' };
  const recLabels = { APPROVE:'Aprovar', REVIEW:'Revis√£o Manual (EDD)', BLOCK:'Bloquear Opera√ß√£o' };

  // Header
  document.getElementById('reportHeader').innerHTML = `
    <div>
      <div class="risk-badge risk-${d.level}">${icons[d.level]||'‚ùì'} RISCO ${d.level}</div>
      <p style="margin-top:10px;font-size:13px;color:var(--text-muted)">${d.summary}</p>
    </div>
    <div style="text-align:right">
      <span class="rec rec-${d.recommendation}">${recLabels[d.recommendation]||d.recommendation}</span>
      <div style="margin-top:6px;font-size:12px;color:var(--text-muted)">Score: ${d.score}/100</div>
    </div>`;

  const sa = r.input.address;
  const shortAddr = sa.length>20 ? sa.substring(0,10)+'...'+sa.substring(sa.length-8) : sa;
  document.getElementById('metaRow').innerHTML = `
    <span>ID: <span class="mono">${r.id}</span></span>
    <span>Rede: <span class="mono">${r.input.chain.toUpperCase()}</span></span>
    <span>Endere√ßo: <span class="mono" title="${sa}">${shortAddr}</span></span>
    <span>Data: ${new Date(r.timestamp).toLocaleString('pt-BR')}</span>`;

  // Findings
  const fl = document.getElementById('findingsList');
  fl.innerHTML = r.findings.length === 0
    ? '<div class="no-findings">‚úÖ Nenhum indicador de risco detectado.</div>'
    : r.findings.map(f=>`<div class="finding sev-${f.severity}"><span class="sev-tag t-${f.severity}">${f.severity}</span><div><strong>${f.source}</strong><br/><span style="color:var(--text-muted)">${f.detail}</span></div></div>`).join('');

  // DeFi
  const defi = r.defiAnalysis;
  if (defi) {
    const mx = defi.mixerInteractions?.length||0, bx = defi.bridgeInteractions?.length||0, dx = defi.dexInteractions?.length||0, hp = defi.opaqueHops||0;
    let html = `<div class="defi-grid">
      <div class="defi-card"><div class="num" style="color:${mx>0?'var(--critical)':'var(--green)'}">${mx}</div><div class="lbl">Mixers</div></div>
      <div class="defi-card"><div class="num" style="color:${bx>0?'var(--yellow)':'var(--green)'}">${bx}</div><div class="lbl">Bridges</div></div>
      <div class="defi-card"><div class="num">${dx}</div><div class="lbl">DEX Swaps</div></div>
      <div class="defi-card"><div class="num" style="color:${hp>=3?'var(--red)':'var(--text)'}">${hp}</div><div class="lbl">Saltos Opacos</div></div>
    </div>`;
    if (defi.summary?.patternDescription) html += `<div class="pattern-alert">‚ö†Ô∏è ${defi.summary.patternDescription}</div>`;
    if (mx>0) { html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px"><strong>Mixers detectados:</strong></div>';
      defi.mixerInteractions.forEach(m=>{ html += `<div class="kyc-action" style="border-left-color:var(--critical)"><strong>${m.name}</strong> ‚Äî ${m.direction} ‚Äî <span class="mono">${(m.hash||'').substring(0,16)}...</span></div>`; }); }
    if (bx>0) { html += '<div style="font-size:12px;color:var(--text-muted);margin:8px 0"><strong>Bridges detectadas:</strong></div>';
      defi.bridgeInteractions.forEach(b=>{ html += `<div class="kyc-action" style="border-left-color:var(--yellow)"><strong>${b.name}</strong> ‚Äî ${b.direction}</div>`; }); }
    document.getElementById('defiContent').innerHTML = html;
    document.getElementById('defiSection').style.display = '';
  }

  // Flash Token Detection
  const flash = r.flashAnalysis;
  if (flash?.checked) {
    let fhtml = '';
    if (flash.flashTokensDetected) {
      fhtml += '<div class="flash-alert flash-danger">‚ö†Ô∏è <strong>FLASH TOKEN DETECTADO!</strong> Esta carteira cont√©m token(s) que N√ÉO s√£o do contrato oficial. Estes tokens s√£o falsos ‚Äî n√£o t√™m valor e n√£o podem ser transferidos ou vendidos. <strong>N√ÉO aceitar como pagamento.</strong></div>';
    } else if (flash.officialTokensFound?.length > 0 && flash.suspiciousTokens?.length === 0) {
      fhtml += '<div class="flash-alert flash-safe">‚úÖ Todos os tokens verificados s√£o de contratos oficiais. Nenhum flash token detectado.</div>';
    } else if (flash.suspiciousTokens?.length > 0) {
      fhtml += '<div class="flash-alert flash-warn">‚ö†Ô∏è ' + flash.summary + '</div>';
    } else {
      fhtml += '<div class="flash-alert flash-safe">‚úÖ ' + (flash.summary || 'Verifica√ß√£o conclu√≠da.') + '</div>';
    }

    // Official tokens
    if (flash.officialTokensFound?.length) {
      fhtml += '<div style="font-size:11px;color:var(--text-muted);margin:12px 0 6px;text-transform:uppercase;letter-spacing:0.06em;font-weight:600">Tokens Oficiais Verificados</div>';
      flash.officialTokensFound.forEach(t => {
        fhtml += '<div class="flash-token-item"><span class="flash-status status-ok">‚úì OFICIAL</span><span style="font-weight:700;color:var(--green)">' + t.symbol + '</span><span style="font-family:monospace;font-size:11px;color:var(--text-muted)">' + (t.balance||'') + '</span><span style="font-size:10px;color:var(--text-muted)">' + t.issuer + '</span></div>';
      });
    }

    // Suspicious tokens
    if (flash.suspiciousTokens?.length) {
      fhtml += '<div style="font-size:11px;color:var(--red);margin:12px 0 6px;text-transform:uppercase;letter-spacing:0.06em;font-weight:600">Tokens Suspeitos</div>';
      flash.suspiciousTokens.forEach(t => {
        const statusClass = t.status.includes('FLASH') ? 'status-fake' : 'status-warn';
        const statusIcon = t.status.includes('FLASH') ? '‚úó FALSO' : '? VERIFICAR';
        fhtml += '<div class="flash-token-item"><span class="flash-status ' + statusClass + '">' + statusIcon + '</span><span style="font-weight:700;color:var(--red)">' + t.symbol + '</span><span style="font-size:11px;color:var(--text-muted)">' + (t.reason||t.status) + '</span></div>';
      });
    }

    document.getElementById('flashContent').innerHTML = fhtml;
    document.getElementById('flashSection').style.display = '';
  } else {
    document.getElementById('flashSection').style.display = 'none';
  }

  // KYC
  if (c.kyc) {
    let html = `<div style="margin-bottom:12px;font-size:13px"><strong>Status:</strong> <span style="color:var(--red)">${c.kyc.status}</span><br/><strong>N√≠vel:</strong> ${c.kyc.requirement}</div>`;
    if (c.kyc.actions?.length) { html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px"><strong>A√ß√µes obrigat√≥rias:</strong></div>';
      c.kyc.actions.forEach((a,i)=>{ html += `<div class="kyc-action"><strong>${i+1}.</strong> ${a}</div>`; }); }
    if (c.kyc.documentsRequired?.length) { html += '<div style="font-size:12px;color:var(--text-muted);margin:12px 0 8px"><strong>Documentos exigidos:</strong></div><div class="doc-list" style="background:var(--surface-2);border-radius:8px;overflow:hidden">';
      c.kyc.documentsRequired.forEach(d=>{ html += `<div class="doc-item"><span>${d.name}</span><span class="${d.required?'required-tag':'optional-tag'}">${d.required?'OBRIGAT√ìRIO':'Recomendado'}</span></div>`; });
      html += '</div>'; }
    document.getElementById('kycContent').innerHTML = html;
    document.getElementById('kycSection').style.display = '';
  }

  // AML/KYT
  if (c.amlKyt) {
    const a = c.amlKyt;
    const sColors = { ACTIVE:'var(--green)', PARTIAL:'var(--yellow)', INSUFFICIENT:'var(--red)' };
    let html = `<div style="font-size:13px;margin-bottom:12px"><strong>Status:</strong> <span style="color:${sColors[a.status]||'var(--text)'}">${a.status}</span> ‚Äî Cobertura: <strong>${a.coveragePercent}%</strong><br/>${a.recommendation}</div>`;
    if (a.activeProviders?.length) { html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:6px"><strong>Fontes ativas:</strong></div>';
      a.activeProviders.forEach(p=>{ html += `<div style="font-size:12px;padding:4px 0"><span style="color:var(--green)">‚óè</span> ${p}</div>`; }); }
    if (a.inactiveProviders?.length) { html += '<div style="font-size:12px;color:var(--text-muted);margin:8px 0 6px"><strong>N√£o configuradas:</strong></div>';
      a.inactiveProviders.forEach(p=>{ html += `<div style="font-size:12px;padding:4px 0;color:var(--text-muted)">‚óã ${p}</div>`; }); }
    document.getElementById('amlContent').innerHTML = html;
    document.getElementById('amlSection').style.display = '';
  }

  // Regulatory
  if (c.regulatoryCooperation) {
    const reg = c.regulatoryCooperation;
    const sMap = { SAR_REQUIRED:['COMUNICA√á√ÉO AO COAF OBRIGAT√ìRIA','var(--critical)'], ENHANCED_MONITORING:['Monitoramento Refor√ßado','var(--yellow)'], STANDARD:['Procedimento Padr√£o','var(--green)'] };
    const [sLabel,sColor] = sMap[reg.status]||[reg.status,'var(--text)'];
    let html = `<div style="font-size:14px;font-weight:700;color:${sColor};margin-bottom:12px">${sLabel}</div>`;
    if (reg.obligations?.length) {
      html += '<table class="reg-table"><thead><tr><th>Regula√ß√£o</th><th>A√ß√£o</th><th>Prazo</th><th>Prioridade</th></tr></thead><tbody>';
      reg.obligations.forEach(o=>{ html += `<tr><td>${o.regulation}</td><td>${o.action}</td><td>${o.deadline}</td><td><span class="priority-tag pri-${o.priority}">${o.priority}</span></td></tr>`; });
      html += '</tbody></table>'; }
    if (reg.jurisdictions?.length) html += `<div style="font-size:11px;color:var(--text-muted);margin-top:8px"><strong>Jurisdi√ß√µes:</strong> ${reg.jurisdictions.join(', ')}</div>`;
    document.getElementById('regContent').innerHTML = html;
    document.getElementById('regSection').style.display = '';
  }

  // On-chain
  const exp = r.sources.explorer;
  const grid = document.getElementById('onchainGrid');
  if (exp?.enabled && exp?.data) {
    const d = exp.data;
    grid.innerHTML = [
      cell('Saldo',d.balance||'N/A'), cell('Transa√ß√µes',d.txCount??'N/A'),
      cell('Token Txs',d.tokenTxCount??'N/A'), cell('Stablecoin Txs',d.stablecoinTxCount??'N/A'),
      cell('Primeira Tx',d.firstTransaction?new Date(d.firstTransaction).toLocaleDateString('pt-BR'):'N/A'),
      cell('√öltima Tx',d.lastTransaction?new Date(d.lastTransaction).toLocaleDateString('pt-BR'):'N/A'),
      cell('Counterparties',d.uniqueCounterparties??'N/A'), cell('Contrato Int.',d.contractInteractions??'N/A')
    ].join('');
    document.getElementById('onchainSection').style.display = '';

    // Token balances
    const tb = document.getElementById('tokenBalances');
    if (d.tokenBalances?.length) {
      tb.innerHTML = '<div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.06em;font-weight:600">Saldo de Tokens</div>' +
        d.tokenBalances.map(t=>`<span class="token-badge"><span class="sym">${t.symbol}</span><span class="bal">${t.balance||''}</span></span>`).join('');
    } else { tb.innerHTML = ''; }

    // Recent transactions
    if (d.recentTransactions?.length) {
      let txHtml = '';
      d.recentTransactions.slice(0,15).forEach(tx=>{
        const addr = tx.direction==='OUT' ? tx.to : tx.from;
        const shortAddr = addr ? (addr.length>20 ? addr.substring(0,8)+'...'+addr.substring(addr.length-6) : addr) : 'N/A';
        const dateStr = tx.date ? new Date(tx.date).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '';
        txHtml += `<div class="tx-row"><span class="tx-dir dir-${tx.direction}">${tx.direction}</span><span class="tx-addr" title="${addr||''}">${shortAddr}</span><span class="tx-val">${tx.value||''}</span><span class="tx-date">${dateStr}</span></div>`;
      });
      document.getElementById('txList').innerHTML = txHtml;
      document.getElementById('txSection').style.display = '';
    } else { document.getElementById('txSection').style.display = 'none'; }

    // Top counterparties
    if (d.topCounterparties?.length) {
      let cpHtml = '';
      d.topCounterparties.slice(0,10).forEach(cp=>{
        const shortAddr = cp.address.length>20 ? cp.address.substring(0,8)+'...'+cp.address.substring(cp.address.length-6) : cp.address;
        const lastDate = cp.lastSeen ? new Date(cp.lastSeen).toLocaleDateString('pt-BR') : '';
        cpHtml += `<div class="cp-row"><span class="cp-count">${cp.txCount}x</span><span class="tx-addr" title="${cp.address}">${shortAddr}</span><span class="tx-date">${lastDate}</span></div>`;
      });
      document.getElementById('cpList').innerHTML = cpHtml;
      document.getElementById('cpSection').style.display = '';
    } else { document.getElementById('cpSection').style.display = 'none'; }

  } else {
    document.getElementById('onchainSection').style.display = 'none';
    document.getElementById('txSection').style.display = 'none';
    document.getElementById('cpSection').style.display = 'none';
  }

  // Transparency
  if (c.proofOfReserves) {
    const p = c.proofOfReserves;
    const tColors = { TRANSPARENT:'var(--green)', PARTIALLY_OPAQUE:'var(--yellow)', OPAQUE:'var(--red)', UNTRACEABLE:'var(--critical)' };
    const tLabels = { TRANSPARENT:'Transparente', PARTIALLY_OPAQUE:'Parcialmente Opaco', OPAQUE:'Opaco', UNTRACEABLE:'Irrastre√°vel' };
    let html = `<div style="font-size:13px;margin-bottom:8px"><strong>Score:</strong> <span style="color:${tColors[p.status]};font-size:18px;font-weight:700">${p.score}/100</span> ‚Äî <span style="color:${tColors[p.status]}">${tLabels[p.status]||p.status}</span></div>`;
    html += `<div class="transparency-bar"><div class="transparency-fill" style="width:${p.score}%;background:${tColors[p.status]}"></div></div>`;
    html += `<div style="font-size:12px;margin:8px 0"><strong>Rastreabilidade:</strong> ${p.fundTraceability}</div>`;
    if (p.factors?.length) { html += '<div style="font-size:12px;color:var(--text-muted);margin:8px 0"><strong>Fatores:</strong></div>';
      p.factors.forEach(f=>{ const c2 = f.impact<-20?'var(--red)':f.impact<0?'var(--yellow)':'var(--green)';
        html += `<div style="font-size:12px;padding:4px 0">‚óè <strong>${f.factor}</strong> (<span style="color:${c2}">${f.impact>0?'+':''}${f.impact}</span>): ${f.detail}</div>`; }); }
    if (p.recommendation) html += `<div style="font-size:12px;margin-top:8px;padding:10px;background:var(--surface-2);border-radius:8px"><strong>Recomenda√ß√£o:</strong> ${p.recommendation}</div>`;
    document.getElementById('transContent').innerHTML = html;
    document.getElementById('transSection').style.display = '';
  }

  // Audit Trail
  if (c.auditTrail) {
    const at = c.auditTrail;
    let html = '';
    if (at.entries?.length) { at.entries.forEach(e=>{ html += `<div class="audit-entry"><span class="audit-action">${e.action}</span><span style="flex:1;color:var(--text-muted)">${e.detail}</span><span style="color:var(--text-muted);font-size:10px">${e.actor}</span></div>`; }); }
    if (at.reportHash) html += `<div style="font-size:11px;color:var(--text-muted);margin-top:8px"><strong>Hash:</strong> <span class="mono">${at.reportHash}</span> | <strong>Reten√ß√£o:</strong> ${at.retentionPolicy||'5 anos'}</div>`;
    document.getElementById('auditContent').innerHTML = html;
    document.getElementById('auditSection').style.display = '';
  }

  // Sources
  const sg = document.getElementById('sourcesGrid');
  const src = r.sources;
  sg.innerHTML = [
    sourcePill('OFAC/SDN',src.ofac), sourcePill('Explorer',src.explorer),
    sourcePill('Heur√≠sticas',src.heuristics), sourcePill('DeFi Analysis',src.defiAnalysis),
    sourcePill('Flash USDT',src.flashDetection),
    sourcePill('Chainabuse',src.chainabuse), sourcePill('Blocksec',src.blocksec)
  ].join('');

  document.getElementById('disclaimer').textContent = r.disclaimer;
  document.getElementById('jsonViewer').textContent = JSON.stringify(data, null, 2);
  document.getElementById('jsonViewer').classList.remove('show');
}

function cell(label,value) { return `<div class="data-cell"><div class="lbl">${label}</div><div class="val">${value}</div></div>`; }
function sourcePill(name,src) {
  if (!src) return `<div class="source-pill"><span class="indicator inactive"></span>${name} ‚Äî N/A</div>`;
  const s = src.error?'error':src.enabled!==false?'active':'inactive';
  const l = src.error?'Erro':src.enabled!==false?'Ativo':'N√£o config.';
  return `<div class="source-pill"><span class="indicator ${s}"></span>${name} ‚Äî ${l}</div>`;
}

async function downloadPDF() {
  if (!lastResult) return;
  const btn = event.target; btn.disabled = true; btn.textContent = 'Gerando PDF...';
  try {
    const res = await fetch('/api/report/pdf', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(lastResult) });
    if (!res.ok) { const t = await res.text(); throw new Error(`HTTP ${res.status}: ${t.substring(0,100)}`); }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = `relatorio-aml-${lastResult.report.id}.pdf`;
    a.click(); URL.revokeObjectURL(url);
  } catch (err) { alert('Erro ao gerar PDF: '+err.message); }
  btn.disabled = false; btn.textContent = 'Baixar Relat√≥rio PDF';
}

function toggleJSON() { document.getElementById('jsonViewer').classList.toggle('show'); }
function exportJSON() {
  if (!lastResult) return;
  const blob = new Blob([JSON.stringify(lastResult,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `aml-report-${lastResult.report.id}.json`; a.click();
}

document.getElementById('address').addEventListener('keydown',e=>{ if(e.key==='Enter') runScreening(); });
</script>
</body>
</html>
